<div class="assessment-container">
    <h3 class="top-container">
        <!--back button only used in tutor dashboard-->
        <div class="row-container mr-2">
            <fa-icon *ngIf="showBackButton" [icon]="'arrow-left'" (click)="goToExerciseDashboard()" class="back-button mr-2"></fa-icon>
            <span jhiTranslate="modelingAssessmentEditor.assessment">Assessment</span>
        </div>
        <jhi-alert></jhi-alert>
        <div class="row-container" *ngIf="!isLoading">
            <span
                *ngIf="!isAssessor"
                class="text-danger ml-3"
                style="font-size: 65%"
                jhiTranslate="modelingAssessmentEditor.assessmentLocked"
                [translateValues]="{ otherUser: result?.assessor?.firstName }"
            >
                Assessment locked by another user!
            </span>
            <span *ngIf="isAssessor" class="text-danger ml-3" style="font-size: 65%" jhiTranslate="modelingAssessmentEditor.assessmentLockedCurrentUser">
                You have the lock for this assessment
            </span>
            <div *ngIf="!result?.completionDate">
                <button class="btn ml-2 btn-primary" (click)="onSaveAssessment()" [disabled]="!assessmentsAreValid || !isAssessor">
                    <fa-icon icon="save"></fa-icon>
                    <span jhiTranslate="entity.action.save">Save</span>
                </button>
                <button class="btn ml-2 btn-success" (click)="onSubmitAssessment()" [disabled]="!assessmentsAreValid || !isAssessor">
                    <span jhiTranslate="entity.action.submit">Submit</span>
                </button>
                <button class="btn ml-2 btn-danger" (click)="onCancelAssessment()" [disabled]="!isAssessor">
                    <span jhiTranslate="entity.action.cancel">Cancel</span>
                </button>
            </div>
            <button class="btn ml-2 btn-danger" *ngIf="result?.completionDate && canOverride" (click)="onSubmitAssessment()" [disabled]="!assessmentsAreValid">
                <span jhiTranslate="modelingAssessmentEditor.button.overrideAssessment">Override Assessment</span>
            </button>
            <button class="btn ml-2 btn-success" [hidden]="!conflicts" (click)="onShowConflictResolution()">
                <span jhiTranslate="modelingAssessmentEditor.button.resolveConflict">Resolve Conflict</span>
            </button>
            <button
                class="btn ml-2 btn-success"
                *ngIf="result?.completionDate && (isAssessor || isAtLeastInstructor) && !complaint"
                [disabled]="busy"
                (click)="assessNextOptimal()"
            >
                <fa-icon *ngIf="busy" icon="spinner" [spin]="true">&nbsp;</fa-icon>
                <span jhiTranslate="modelingAssessmentEditor.button.nextSubmission"> Next Submission</span>
            </button>
        </div>
    </h3>
    <div *ngIf="complaint">
        <div class="alert alert-info" *ngIf="complaint.complaintType === ComplaintType.COMPLAINT">{{ 'artemisApp.complaint.hint' | translate }}</div>
        <div class="alert alert-info" *ngIf="complaint.complaintType === ComplaintType.MORE_FEEDBACK">{{ 'artemisApp.moreFeedback.hint' | translate }}</div>
    </div>

    <div class="alert alert-info" *ngIf="hasAutomaticFeedback && isAssessor && !result?.completionDate" jhiTranslate="modelingAssessmentEditor.automaticAssessmentAvailable">
        Congratulations! Parts of this model could already be assessed automatically. Please review the automatic assessment and complete the assessment afterwards. By submitting
        the assessment you also confirm the automatic assessment. Please be aware that you are responsible for the whole assessment.
    </div>
    <div class="editor-container flex-grow-1">
        <jhi-modeling-assessment
            *ngIf="submission"
            [diagramType]="modelingExercise?.diagramType"
            [maxScore]="modelingExercise?.maxScore"
            [model]="model"
            [feedbacks]="result?.feedbacks"
            [highlightedElements]="highlightedElements"
            (feedbackChanged)="onFeedbackChanged($event)"
        ></jhi-modeling-assessment>
        <jhi-assessment-instructions *ngIf="modelingExercise" [exercise]="modelingExercise" [collapsed]="false"></jhi-assessment-instructions>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <h4 jhiTranslate="artemisApp.assessment.generalFeedback">General Feedback</h4>
            <div>
                <textarea class="form-control" rows="2" maxlength="5000" [(ngModel)]="generalFeedback.detailText" (ngModelChange)="validateFeedback()"></textarea>
            </div>
        </div>
        <div class="col-md-6" *ngIf="(hasAutomaticFeedback || highlightMissingFeedback) && !result?.completionDate">
            <h4 jhiTranslate="modelingAssessmentEditor.highlightingColors.title">Highlighting Color(s)</h4>
            <div class="row" *ngIf="hasAutomaticFeedback">
                <div class="mx-3 mb-2 highlighting-item color-cyan"></div>
                <span jhiTranslate="modelingAssessmentEditor.highlightingColors.automaticAssessment">automatic assessment</span>
            </div>
            <div class="row" *ngIf="highlightMissingFeedback">
                <div class="mx-3 mb-2 highlighting-item color-red"></div>
                <span jhiTranslate="modelingAssessmentEditor.highlightingColors.missingAssessment">missing assessment</span>
            </div>
        </div>
    </div>
</div>
<div class="mt-3" *ngIf="complaint">
    <jhi-complaints-for-tutor-form
        [complaint]="complaint"
        [isAllowedToRespond]="complaint.complaintType === ComplaintType.COMPLAINT ? !isAssessor : isAssessor"
        (updateAssessmentAfterComplaint)="onUpdateAssessmentAfterComplaint($event)"
    >
    </jhi-complaints-for-tutor-form>
</div>
